<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order / Payment</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="../static/css/styles.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.iamport.kr/js/iamport.payment-1.1.7.js"></script>
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --background-color: #f8f9fa;
            --text-color: #212529;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            font-family: Arial, sans-serif;
        }

        .banner {
            background-image: url('/image/banner.jpg');
            background-size: cover;
            background-position: center;
            height: 200px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .banner h1 {
            margin: 0;
        }

        .order-form {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }

        .order-summary {
            background-color: var(--secondary-color);
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .order-summary h2 {
            margin-top: 0;
        }

        .order-summary .total {
            font-size: 1.5em;
        }

        .btn-primary {
            background-color: var(--primary-color);
            border: none;
        }

        .btn-primary:hover {
            background-color: darken(var(--primary-color), 10%);
        }

        footer {
            background-color: var(--secondary-color);
            color: white;
            text-align: center;
            padding: 10px 0;
            position: absolute;
            width: 100%;
            bottom: 0;
        }
    </style>
</head>
<body>
<header th:replace="header :: header"></header>
<div class="banner">
    <h1>Checkout</h1>
</div>
<div class="container mt-5">
    <div class="order-summary">
        <h2>주문 / 결제</h2>
        <div class="product-info" th:each="item : ${order.items}">
            <img class="product-image" th:src="@{${item.mainImage}}" alt="Product Image" style="width: 100px; height: auto;">
            <span class="product-name" th:text="${item.productName}"></span> X <span class="product-quantity" th:text="${item.quantity}"></span><br>
            <span>배송비: </span><span class="shipping-cost" th:text="${item.shipping}"></span><br>
            <span>Total: </span><span class="total-price" th:text="${item.price + item.shipping}"></span>원<br>
        </div>
    </div>
    <form id="orderForm" class="order-form">
        <div class="mb-3">
            <label for="orderName" class="form-label">이름</label>
            <input type="text" id="orderName" name="orderName" class="form-control" required>
        </div>
        <div class="mb-3">
            <label for="orderAddress1" class="form-label">배송지 주소</label>
            <input type="text" id="orderAddress1" name="orderAddress1" class="form-control" required>
        </div>
        <div class="mb-3">
            <label for="orderAddress2" class="form-label">상세주소</label>
            <input type="text" id="orderAddress2" name="orderAddress2" class="form-control" required>
        </div>
        <div class="mb-3">
            <label for="orderRecipient" class="form-label">수령인</label>
            <input type="text" id="orderRecipient" name="orderRecipient" class="form-control" required>
        </div>
        <div class="mb-3">
            <label for="orderPhone" class="form-label">휴대전화번호</label>
            <input type="text" id="orderPhone" name="orderPhone" class="form-control" required>
        </div>
        <div class="mb-3">
            <label for="orderComment" class="form-label">요청사항</label>
            <input type="text" id="orderComment" name="orderComment" class="form-control">
        </div>
        <button type="button" id="payButton" class="btn btn-primary">지금 결제</button>
    </form>
    <div class="order-summary mt-5">
        <img src="https://cdn.iamport.kr/images/payment-logo/inicis/inicis.svg" alt="KG Inicis" style="width: 100px;">
        <p>‘지금 결제’를 클릭한 후, 주문을 안전하게 완료하기 위해 KG Inicis (New)로 다시 연결됩니다.</p>
        <p>계좌이체 기업은행: 000000-000-000000 예금주 (주)EVO</p>
    </div>
</div>
<footer th:replace="footer :: footer"></footer>
<script>
    var IMP = window.IMP;
    IMP.init('imp77114780');

    $('#payButton').click(function () {
        var orderName = $('#orderName').val();
        var orderAddress1 = $('#orderAddress1').val();
        var orderAddress2 = $('#orderAddress2').val();
        var orderRecipient = $('#orderRecipient').val();
        var orderPhone = $('#orderPhone').val();
        var orderComment = $('#orderComment').val();
        var orderAmount = 0;

        $('.total-price').each(function () {
            orderAmount += parseInt($(this).text());
        });

        IMP.request_pay({
            pg: 'html5_inicis',
            pay_method: 'card',
            merchant_uid: 'merchant_' + new Date().getTime(),
            name: 'Total Order',
            amount: orderAmount,
            buyer_email: 'buyer@example.com',
            buyer_name: orderName,
            buyer_tel: orderPhone,
            buyer_addr: orderAddress1 + ' ' + orderAddress2,
            buyer_postcode: '123-456'
        }, function (rsp) {
            if (rsp.success) {
                var order = {
                    productNo: $('#productNo').val(),
                    quantity: $('#quantity').val(),
                    orderName: orderName,
                    orderAddress1: orderAddress1,
                    orderAddress2: orderAddress2,
                    orderRecipient: orderRecipient,
                    orderPhone: orderPhone,
                    orderComment: orderComment,
                    orderAmount: orderAmount,
                    orderStatus: 0, // 결제 대기 상태로 설정
                    items: []
                };

                $('.product-info').each(function () {
                    var item = {
                        productName: $(this).find('.product-name').text(),
                        quantity: $(this).find('.product-quantity').text(),
                        shippingCost: $(this).find('.shipping-cost').text(),
                        price: $(this).find('.total-price').text(),
                        image: $(this).find('.product-image').attr('src')
                    };
                    order.items.push(item);
                });

                $.ajax({
                    type: 'POST',
                    url: '/orders/processPayment',  // 서버의 결제 처리 URL
                    contentType: 'application/json',
                    data: JSON.stringify(order),
                    success: function () {
                        window.location.href = '/orders';
                    },
                    error: function (error) {
                        console.error('Error:', error);
                        alert('주문을 완료하는 중 오류가 발생했습니다.');
                    }
                });
            } else {
                alert('Payment failed: ' + rsp.error_msg);
            }
        });
    });
</script>
</body>
</html>
