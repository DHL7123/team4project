<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title>Product List</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css" />
  <link rel="stylesheet" th:href="@{/css/styles.css}">
  <link rel="stylesheet" th:href="@{/css/list.css}">
  <script>
    // URL 파라미터에서 특정 파라미터 값을 가져오는 함수
    function getParameterByName(name) {
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }

    // 정렬 기준 변경 함수
    function onSortChange() {
      const sort = document.getElementById("sortSelect").value;
      const currentPage = document.getElementById("currentPage").value;
      const categoryId = document.getElementById("categoryId").value;
      const input = document.getElementById("input").value;

      let url;
      if (categoryId) {
        // 카테고리별 조회
        url = "/product/category/" + categoryId + "?sort=" + sort + "&page=" + currentPage + "&size=16";
      } else if (input && input.trim() !== "") {
        // 검색 결과 조회
        url = "/product/search/" + encodeURIComponent(input) + "?sort=" + sort + "&page=" + currentPage + "&size=16";
      } else {
        // 전체 상품 조회
        url = "/product?sort=" + sort + "&page=" + currentPage + "&size=16";
      }

      window.location.href = url;
    }

    // 각 상품에 클릭 리스너 추가
    document.addEventListener('DOMContentLoaded', function () {
      const products = document.querySelectorAll('.product');
      products.forEach(function (product) {
        const addToCartButton = product.querySelector('.add-to-cart');
        product.addEventListener('click', function (event) {
          if (event.target !== addToCartButton) {
            const productNo = product.getAttribute('data-product-no');
            console.log('Redirecting to product number:', productNo);
            redirectToDetailPage(productNo);
          }
        });
      });
    });

    // 상세 페이지로 리다이렉트하는 함수
    function redirectToDetailPage(productNo) {
      window.location.href = '/product/detail/' + productNo;
    }
  </script>
</head>
<body class="bg-light">

<header th:replace="header :: header" class="mb-4"></header>

<div class="container">
  <h1 class="text-center mb-4">Product List</h1>

  <!-- 검색 입력 필드 -->
  <input type="hidden" id="input" th:value="${productName}" />

  <!-- 정렬 드롭다운 -->
  <div class="mb-3">
    <select id="sortSelect" class="form-select" onchange="onSortChange()">
      <option value="pro_date_desc" th:selected="${productsResponse.sort == 'pro_date_desc'}">최근 등록순</option>
      <option value="price_asc" th:selected="${productsResponse.sort == 'price_asc'}">가격 오름차순</option>
      <option value="price_desc" th:selected="${productsResponse.sort == 'price_desc'}">가격 내림차순</option>
      <option value="viewCount_desc" th:selected="${productsResponse.sort == 'viewCount_desc'}">조회수순</option>
    </select>
    <input type="hidden" id="categoryId" th:value="${categoryId}">
  </div>

  <!-- 현재 페이지를 숨김 필드로 추가 -->
  <input type="hidden" id="currentPage" th:value="${productsResponse.currentPage}" />

  <!-- 상품 목록 -->
  <div id="product-container" class="row row-cols-1 row-cols-md-4 g-4">
    <div th:each="product : ${products}" class="col">
      <div class="product card h-100" th:data-product-no="${product.productNo}">
        <img th:if="${product.mainImage != null}" th:src="@{${product.mainImage.imageName}}" alt="Product Image" class="card-img-top">
        <div class="card-body">
          <h5 class="card-title" th:text="${product.productName}">Product Name</h5>
          <p class="card-text" th:text="${product.soldout ? 'Sold Out' : product.price + ' 원'}"></p>
        </div>
        <div class="card-footer text-center">
          <div class="add-to-cart btn btn-primary" th:if="${!product.soldout}">Add to cart</div>
        </div>
      </div>
    </div>
  </div>

  <!-- 페이지네이션 -->
  <div class="pagination">
    <ul class="pagination">
      <!-- 이전 페이지 버튼 -->
      <li class="page-item" th:if="${productsResponse.currentPage > 1}">
        <a class="page-link" th:href="@{${categoryId != null ? '/product/category/' + categoryId : '/product/search/' + productName}(page=${productsResponse.currentPage - 1}, size=16, sort=${productsResponse.sort})}">Prev</a>
      </li>

      <!-- 페이지 번호 반복 -->
      <li class="page-item" th:each="pageNum : ${#numbers.sequence(1, productsResponse.totalPages)}" th:classappend="${pageNum == productsResponse.currentPage} ? 'active'">
        <a class="page-link" th:href="@{${categoryId != null ? '/product/category/' + categoryId : '/product/search/' + productName}(page=${pageNum}, size=16, sort=${productsResponse.sort})}" th:text="${pageNum}">1</a>
      </li>

      <!-- 다음 페이지 버튼 -->
      <li class="page-item" th:if="${productsResponse.currentPage < productsResponse.totalPages}">
        <a class="page-link" th:href="@{${categoryId != null ? '/product/category/' + categoryId : '/product/search/' + productName}(page=${productsResponse.currentPage + 1}, size=16, sort=${productsResponse.sort})}">Next</a>
      </li>
    </ul>
  </div>
</div>

<footer th:replace="footer :: footer" class="mt-5"></footer>
</body>
</html>
